<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Prepease — Sauces & Spreads (Cash on Delivery)</title>
<meta name="description" content="Chef-crafted sauces & spreads. Order online with Cash on Delivery.">
<style>
  :root{
    --brand:#ff4d2d;--brand-2:#ffb703;--ink:#1d1d1f;--muted:#5f6368;
    --bg:#fffdf8;--card:#ffffff;--line:#ece7df;--ok:#129c5d;--danger:#c62828;
    --shadow:0 10px 30px rgba(0,0,0,.06);--radius:14px;--max:1200px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  body{overflow-x:hidden}
  img{max-width:100%;height:auto;display:block} a{color:var(--brand);text-decoration:none}
  .container{max-width:var(--max);margin:auto;padding:0 20px}
  .btn{display:inline-flex;align-items:center;gap:.6rem;background:var(--brand);color:#fff;border:none;border-radius:999px;padding:.75rem 1.1rem;font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:.2s}
  .btn:hover{opacity:.95;transform:translateY(-1px)}
  .btn.secondary{background:#111} .btn.ghost{background:#fff;color:#111;border:1px solid var(--line)}
  .badge{display:inline-block;padding:.35rem .6rem;border:1px solid var(--line);border-radius:999px;font-size:.8rem;color:var(--muted);background:#fff}
  .grid{display:grid;gap:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:50}
  .nav{display:flex;align-items:center;justify-content:space-between;height:64px}
  .brand{display:flex;align-items:center;gap:.7rem;font-weight:800}
  .logo{inline-size:30px;block-size:30px;border-radius:8px;background:conic-gradient(from 200deg,var(--brand),var(--brand-2));box-shadow:var(--shadow)}
  nav ul{display:flex;gap:.7rem;list-style:none;margin:0;padding:0;flex-wrap:wrap}
  nav a{padding:.5rem .7rem;border-radius:999px} nav a:hover{background:#f6efe6}
  .menu{display:none}.nav-cta{display:flex;gap:.5rem;align-items:center}
  .hero{padding:52px 0 26px;background:radial-gradient(1200px 500px at 75% -50%, rgba(255,183,3,.25), transparent 70%), radial-gradient(1000px 500px at -10% 10%, rgba(255,77,45,.15), transparent 70%)}
  .hero-wrap{display:grid;grid-template-columns:1.2fr .8fr;gap:24px;align-items:center}
  .headline{font-size:clamp(1.8rem,3.5vw,3rem);line-height:1.15;margin:.2rem 0 .6rem}
  .sub{color:var(--muted);font-size:1.05rem;max-width:50ch}
  .hero-img{aspect-ratio:4/3;border-radius:var(--radius);border:1px solid var(--line);display:grid;place-items:center;background:linear-gradient(135deg,#fff,#fff4e7 35%, #ffe7e0);padding:10px}
  .hero-img .mock{aspect-ratio:4/3;border-radius:12px;border:2px dashed #ffc7b9;display:grid;place-items:center;color:#c24e2b;font-weight:700;width:100%}
  .section{padding:48px 0} .section h2{margin:0 0 12px;font-size:clamp(1.4rem,2.3vw,2rem)}
  .products{grid-template-columns:repeat(3,1fr)} .product{padding:14px;display:grid;gap:10px}
  .product .img{aspect-ratio:4/3;border-radius:12px;border:1px solid var(--line);display:grid;place-items:center;background:linear-gradient(135deg,#fff7f3,#ffe3da);font-weight:700;color:#c24e2b}
  .row{display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap}
  .price{font-weight:800} .strike{color:#777;text-decoration:line-through;font-weight:500;margin-left:.4rem}
  .qty{display:flex;align-items:center;gap:.35rem} .qty button{border:1px solid var(--line);background:#fff;border-radius:8px;padding:.3rem .55rem;cursor:pointer}
  input,select,textarea{width:100%;padding:.8rem;border:1px solid var(--line);border-radius:12px;background:#fff}
  textarea{min-height:90px;resize:vertical}
  .muted{color:#777}
  footer{padding:24px 0;border-top:1px solid var(--line);color:#555}

  /* Breadcrumbs (fixed wrapping + safe ellipsis) */
  .crumbs-wrap{background:#fff;border-bottom:1px solid var(--line)}
  .crumbs{display:flex;align-items:center;gap:.4rem;flex-wrap:wrap;line-height:1.2;padding:10px 0}
  .crumbs a, .crumbs span{display:inline-flex;align-items:center;gap:.4rem;max-width:100%;min-width:0}
  .crumbs .seg{padding:.35rem .6rem;border:1px solid var(--line);border-radius:999px;background:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .crumbs .sep{color:#bbb;user-select:none}
  .crumbs .seg.current{background:#fff7ef;border-color:#ffd6c7}

  /* Page shells */
  main{min-height:60vh}
  .page{display:none}
  .page.active{display:block}
  .content{padding:22px 0}

  /* Cart/Checkout pages: non-sticky, scrollable, no zoom tricks */
  .cart-list{display:grid;gap:12px}
  .cart-line{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px}
  .mini-img{inline-size:56px;block-size:46px;border-radius:8px;border:1px solid var(--line);display:grid;place-items:center;background:#fff7f1;color:#c24e2b;font-size:.8rem}
  .totals{margin-top:10px;border-top:1px solid var(--line);padding-top:10px;display:grid;gap:6px}
  .tot{display:flex;justify-content:space-between}

  /* Admin tip */
  .admin{padding:16px;border:1px dashed #e5d8c9;border-radius:12px;background:#fff}

  /* Responsiveness */
  @media (max-width:960px){
    .hero-wrap{grid-template-columns:1fr}
    .products{grid-template-columns:repeat(2,1fr)}
  }
  @media (max-width:680px){
    nav ul{display:none}.menu{display:inline-block}
    .products{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <span>Prepease</span>
        <span class="badge">Cash on Delivery</span>
      </div>
      <nav>
        <ul>
          <li><a href="#/">Home</a></li>
          <li><a href="#/products">Products</a></li>
          <li><a href="#/cart">Cart</a></li>
          <li><a href="#/checkout">Checkout</a></li>
          <li><a href="#/contact">Contact</a></li>
        </ul>
      </nav>
      <div class="nav-cta">
        <a class="btn ghost" href="#/cart" aria-label="Open cart">🛒 <span id="cartCount">0</span></a>
        <button class="menu btn" onclick="document.querySelector('nav ul').style.display='flex'">☰</button>
      </div>
    </div>
    <div class="crumbs-wrap">
      <div class="container">
        <nav aria-label="Breadcrumbs" id="breadcrumbs" class="crumbs"></nav>
      </div>
    </div>
  </header>

  <!-- PAGES -->
  <main>
    <!-- HOME -->
    <section id="page-home" class="page active">
      <div class="hero">
        <div class="container hero-wrap">
          <div>
            <h1 class="headline">Restaurant-Quality Taste. <br>Order Now — <u>Cash on Delivery</u>.</h1>
            <p class="sub">Chef-crafted sauces & spreads for pizzas, sandwiches, and snacks. 100% vegetarian, no preservatives, ready-to-use.</p>
            <div style="display:flex;gap:.7rem;flex-wrap:wrap;margin-top:12px">
              <a class="btn" href="#/products">Shop Products</a>
              <a class="btn secondary" href="#/cart">View Cart</a>
            </div>
          </div>
          <div class="hero-img"><div class="mock">Swap in product photo</div></div>
        </div>
      </div>
      <div class="container content">
        <h2>Best Sellers</h2>
        <div id="homeGrid" class="grid products"></div>
      </div>
    </section>

    <!-- PRODUCTS -->
    <section id="page-products" class="page">
      <div class="container content">
        <h2>Products</h2>
        <div id="productGrid" class="grid products"></div>
        <div class="admin" style="margin-top:16px">
          <b>Store Owner Tips</b>
          <ul style="margin:.4rem 0 0 1rem">
            <li>Replace WhatsApp & Email in the script constants.</li>
            <li>Edit product prices/stock in <code>PRODUCTS</code>.</li>
            <li>Orders save locally and can be exported or sent via WhatsApp/Email.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- CART -->
    <section id="page-cart" class="page">
      <div class="container content">
        <h2>Your Cart</h2>
        <div id="cartList" class="cart-list"></div>
        <div id="cartTotals" class="totals"></div>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-top:10px">
          <a class="btn" href="#/checkout">Proceed to Checkout</a>
          <button class="btn ghost" onclick="clearCart()">Clear Cart</button>
          <a class="btn secondary" href="#/products">Continue Shopping</a>
        </div>
      </div>
    </section>

    <!-- CHECKOUT -->
    <section id="page-checkout" class="page">
      <div class="container content">
        <h2>Checkout — Cash on Delivery</h2>
        <form id="checkoutForm" class="card" style="padding:14px" onsubmit="return placeOrder(event)">
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <input name="name" placeholder="Full Name*" required>
            <input name="phone" placeholder="Phone*" inputmode="tel" required>
          </div>
          <input type="email" name="email" placeholder="Email (optional)">
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <input name="pincode" placeholder="Pincode*" required>
            <input name="city" placeholder="City*" required>
          </div>
          <textarea name="address" placeholder="Full Address*" required></textarea>
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <select name="state" required>
              <option value="" disabled selected>State*</option>
              <option>Maharashtra</option><option>Karnataka</option><option>Delhi</option>
              <option>Gujarat</option><option>Tamil Nadu</option><option>Telangana</option>
              <option>Other</option>
            </select>
            <select name="slot" required>
              <option value="" disabled selected>Delivery Preference*</option>
              <option>Standard (3–5 days)</option>
              <option>Express (1–2 days)</option>
            </select>
          </div>

          <div class="card" style="padding:10px">
            <label style="display:flex;align-items:center;gap:.5rem">
              <input type="radio" name="payment" value="COD" checked> <b>Cash on Delivery (COD)</b>
            </label>
            <p class="muted" style="margin:.4rem 0 0">Pay in cash when your order arrives. A small COD fee may apply.</p>
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr">
            <input name="coupon" placeholder="Coupon code (optional)">
            <button type="button" class="btn ghost" onclick="applyCoupon()">Apply Coupon</button>
          </div>

          <label style="display:flex;align-items:center;gap:.5rem">
            <input type="checkbox" name="agree" required> I agree to the Terms & Privacy.
          </label>

          <div style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center">
            <button class="btn" type="submit">Place Order (COD)</button>
            <span id="checkMsg" class="msg" aria-live="polite" role="status"></span>
          </div>
        </form>

        <aside class="card" style="padding:14px;margin-top:12px">
          <h3>Order Summary</h3>
          <div id="summaryList" class="cart-list"></div>
          <div id="summaryTotals" class="totals"></div>
        </aside>
      </div>
    </section>

    <!-- SUCCESS -->
    <section id="page-success" class="page">
      <div class="container content">
        <h2>🎉 Order Placed</h2>
        <p>Thank you! Your order has been saved. Our team will confirm shortly.</p>
        <div id="successBox" class="card" style="padding:12px;margin:10px 0"></div>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap">
          <a id="waLink" class="btn" target="_blank" rel="nofollow">Send via WhatsApp</a>
          <a id="mailLink" class="btn secondary">Send via Email</a>
          <button class="btn ghost" onclick="downloadOrder()">Download JSON</button>
          <button class="btn ghost" onclick="window.print()">Print</button>
        </div>
        <div class="muted" style="margin-top:8px">Tip: Set your WhatsApp number & order email in the CONFIG section.</div>
        <div style="margin-top:12px;display:flex;gap:.6rem;flex-wrap:wrap">
          <a class="btn" href="#/products">Continue Shopping</a>
          <a class="btn ghost" href="#/cart">Back to Cart</a>
        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="page-about" class="page">
      <div class="container content">
        <h2>About Prepease</h2>
        <p>Chef-crafted sauces & spreads for cafés, cloud kitchens, and homes. 100% vegetarian, preservative-free, and ready-to-use.</p>
      </div>
    </section>

    <!-- CONTACT -->
    <section id="page-contact" class="page">
      <div class="container content">
        <h2>Contact</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div class="card" style="padding:14px">
            <p>📧 <a href="mailto:support@prepease.in">support@prepease.in</a></p>
            <p>📞 <a href="tel:+91XXXXXXXXXX">+91-XXXX-XXXXXX</a></p>
            <p>📍 Nagpur, India</p>
            <p class="muted">Business hours: Mon–Sat, 10:00–18:00 IST</p>
          </div>
          <form id="contactForm" class="card" style="padding:14px" onsubmit="return handleContact(event)">
            <input name="name" placeholder="Name" required>
            <input type="email" name="email" placeholder="Email" required>
            <textarea name="message" placeholder="Your message..." required></textarea>
            <div style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap">
              <button class="btn" type="submit">Send</button>
              <span id="contactMsg" class="msg" aria-live="polite" role="status"></span>
            </div>
          </form>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container" style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap">
      <div>© <span id="year"></span> Prepease</div>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap">
        <a href="#/products">Products</a> · <a href="#/about">About</a> · <a href="#/contact">Contact</a> · <a href="#" onclick="viewLocalOrders()">Saved Orders</a>
      </div>
    </div>
  </footer>

<script>
/* ==========================
   CONFIG — replace these!
========================== */
const STORE_WHATSAPP = "91XXXXXXXXXX"; // e.g., "919876543210" (no +)
const STORE_EMAIL = "orders@yourdomain.com";

/* ==========================
   Sample Product Catalog
========================== */
const PRODUCTS = [
  { id:"PZ-SCHEZZA-250", name:"Schezza Base (Schezwan Pizza Redimix) 250g", price:179, mrp:199, img:"Schezza Base", stock:50 },
  { id:"PZ-SCHEZZA-500", name:"Schezza Base 500g", price:329, mrp:359, img:"Schezza Base", stock:40 },
  { id:"SD-SCHEZZO-250", name:"Schezzo Spread (Schezwan Sandwich Premix) 250g", price:169, mrp:189, img:"Schezzo Spread", stock:60 },
  { id:"PZ-TANDOOR-250", name:"Tandoori Flame Pizza Base 250g", price:189, mrp:209, img:"Tandoori Flame", stock:50 },
  { id:"PZ-ROYAL-250", name:"Royal Tikka Pizza Base 250g", price:199, mrp:219, img:"Royal Tikka", stock:38 },
  { id:"SD-TGRILL-250", name:"Tandoori Grill Sandwich Spread 250g", price:169, mrp:189, img:"Tandoori Grill", stock:55 },
  { id:"SD-HERIT-250", name:"Heritage Tikka Sandwich Spread 250g", price:179, mrp:199, img:"Heritage Tikka", stock:52 }
];

/* Fees/Coupons */
const SHIPPING_THRESHOLD = 499;    // Free shipping above this
const SHIPPING_FEE = 49;           // Otherwise this fee
const COD_FEE = 25;                // Flat COD fee
const VALID_COUPONS = { "PREP10": 0.10, "FREESHIP": "FREESHIP" };

/* ==========================
   STATE
========================== */
const $ = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>[...root.querySelectorAll(q)];
const state = {
  cart: JSON.parse(localStorage.getItem("prepease_cart")||"[]"),
  coupon: null,
  totals: { subtotal:0, shipping:0, cod:0, discount:0, grand:0 },
  lastOrder: null
};
function money(n){ return "₹"+n.toFixed(0) }
function persistCart(){ localStorage.setItem("prepease_cart", JSON.stringify(state.cart)); updateCartCount(); }
function updateCartCount(){ $("#cartCount").textContent = state.cart.reduce((a,b)=>a+b.qty,0); }

/* ==========================
   ROUTER (hash-based)
========================== */
const routes = {
  "/": { el:"#page-home", title:"Home" },
  "/products": { el:"#page-products", title:"Products" },
  "/cart": { el:"#page-cart", title:"Cart" },
  "/checkout": { el:"#page-checkout", title:"Checkout" },
  "/success": { el:"#page-success", title:"Success" },
  "/about": { el:"#page-about", title:"About" },
  "/contact": { el:"#page-contact", title:"Contact" }
};
function getPath(){ const h=location.hash.slice(1)||"/"; return h.split("?")[0]; }
function navigate(){
  // Activate page
  const path = getPath();
  $$(".page").forEach(p=>p.classList.remove("active"));
  const match = routes[path] ? path : (path.startsWith("/success")?"/success":"/");
  $(routes[match].el).classList.add("active");
  // Update breadcrumb
  renderBreadcrumb(match);
  // Page-specific renders
  if(match==="/" || match==="/products"){ renderProducts(); }
  if(match==="/"){ renderHomeGrid(); }
  if(match==="/cart"){ renderCartPage(); }
  if(match==="/checkout"){ renderCheckoutSummary(); }
  if(match==="/success"){ renderSuccessPage(); }
  window.scrollTo({top:0,behavior:"instant"});
}
window.addEventListener("hashchange", navigate);

/* ==========================
   BREADCRUMBS (wrapped, no overflow)
========================== */
function renderBreadcrumb(path){
  const bc = $("#breadcrumbs");
  const segs = path.split("/").filter(Boolean);
  const parts = [{name:"Home", href:"#/"}];
  if(segs[0]==="products") parts.push({name:"Products", href:"#/products"});
  if(segs[0]==="cart") parts.push({name:"Cart", href:"#/cart"});
  if(segs[0]==="checkout") parts.push({name:"Checkout", href:"#/checkout"});
  if(segs[0]==="success") parts.push({name:"Success", href:"#/success"});
  if(segs[0]==="about") parts.push({name:"About", href:"#/about"});
  if(segs[0]==="contact") parts.push({name:"Contact", href:"#/contact"});

  bc.innerHTML = parts.map((p,i)=>{
    const segClass = `seg ${i===parts.length-1?'current':''}`;
    const link = i===parts.length-1 ? `<span class="${segClass}" aria-current="page">${p.name}</span>` : `<a class="${segClass}" href="${p.href}">${p.name}</a>`;
    const sep = i<parts.length-1 ? `<span class="sep">›</span>` : "";
    return link+sep;
  }).join("");
}

/* ==========================
   PRODUCT RENDERING
========================== */
function renderHomeGrid(){
  const wrap = $("#homeGrid"); if(!wrap) return;
  wrap.innerHTML = "";
  PRODUCTS.slice(0,3).forEach(p=>wrap.appendChild(productCard(p)));
}
function renderProducts(){
  const wrap = $("#productGrid"); if(!wrap) return;
  wrap.innerHTML = "";
  PRODUCTS.forEach(p=>wrap.appendChild(productCard(p)));
}
function productCard(p){
  const el = document.createElement("article");
  el.className = "card product";
  el.innerHTML = `
    <div class="img">${p.img}</div>
    <h3>${p.name}</h3>
    <div class="row">
      <div><span class="price">${money(p.price)}</span><span class="strike">${money(p.mrp)}</span></div>
      <span class="badge">In stock: ${p.stock}</span>
    </div>
    <div class="row">
      <div class="qty">
        <button aria-label="Decrease">−</button>
        <input type="number" min="1" value="1" style="width:60px;padding:.4rem;border:1px solid var(--line);border-radius:8px">
        <button aria-label="Increase">+</button>
      </div>
      <button class="btn">Add to Cart</button>
    </div>`;
  const qtyInput = el.querySelector("input");
  el.querySelectorAll(".qty button")[0].addEventListener("click",()=>{ qtyInput.value=Math.max(1,parseInt(qtyInput.value||"1")-1);});
  el.querySelectorAll(".qty button")[1].addEventListener("click",()=>{ qtyInput.value=parseInt(qtyInput.value||"1")+1;});
  el.querySelector(".btn").addEventListener("click",()=>{
    const qty = Math.max(1, parseInt(qtyInput.value||"1"));
    addToCart(p.id, qty);
  });
  return el;
}

/* ==========================
   CART
========================== */
function addToCart(id, qty=1){
  const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
  const line = state.cart.find(x=>x.id===id);
  const finalQty = Math.min((line?line.qty:0)+qty, p.stock);
  if(line){ line.qty = finalQty; } else { state.cart.push({id,qty:finalQty,price:p.price,name:p.name}); }
  persistCart();
  renderCartPage();
  location.hash = "#/cart";
}
function changeCartQty(id,delta){
  const line = state.cart.find(x=>x.id===id); if(!line) return;
  const p = PRODUCTS.find(x=>x.id===id);
  line.qty = Math.max(1, Math.min(line.qty+delta, p.stock));
  persistCart(); renderCartPage(); renderCheckoutSummary();
}
function removeFromCart(id){
  state.cart = state.cart.filter(x=>x.id!==id);
  persistCart(); renderCartPage(); renderCheckoutSummary();
}
function clearCart(){
  state.cart = []; persistCart(); renderCartPage(); renderCheckoutSummary();
}
function calcTotals(){
  const subtotal = state.cart.reduce((s,l)=>s + l.qty*l.price, 0);
  let discount = 0, shipping = 0;
  if(state.coupon && VALID_COUPONS[state.coupon]){
    const v = VALID_COUPONS[state.coupon];
    if(v==="FREESHIP") shipping = 0; else discount = subtotal * v;
  }
  if(subtotal - discount < SHIPPING_THRESHOLD){ shipping = (VALID_COUPONS[state.coupon]==="FREESHIP")?0:SHIPPING_FEE; }
  const cod = state.cart.length ? COD_FEE : 0;
  const grand = Math.max(0, Math.round(subtotal - discount + shipping + cod));
  state.totals = { subtotal:Math.round(subtotal), shipping, cod, discount:Math.round(discount), grand };
}
function renderCartPage(){
  // For Cart page
  const list = $("#cartList"); if(!list) return;
  list.innerHTML = "";
  if(!state.cart.length){
    list.innerHTML = `<div class="muted">Your cart is empty. <a href="#/products">Browse products</a>.</div>`;
  }else{
    state.cart.forEach(l=>{
      const p = PRODUCTS.find(x=>x.id===l.id);
      const line = document.createElement("div");
      line.className = "cart-line";
      line.innerHTML = `
        <div class="mini-img">${p.img}</div>
        <div>
          <div style="font-weight:700">${p.name}</div>
          <div class="muted">${p.id}</div>
          <div class="row" style="margin-top:6px">
            <div class="qty">
              <button aria-label="Decrease">−</button>
              <span style="min-width:24px;text-align:center">${l.qty}</span>
              <button aria-label="Increase">+</button>
            </div>
            <div>${money(l.qty*l.price)}</div>
          </div>
        </div>
        <button class="btn ghost">Remove</button>`;
      const [dec, , inc] = line.querySelectorAll(".qty button, .qty span, .qty button");
      dec.addEventListener("click",()=>changeCartQty(l.id,-1));
      inc.addEventListener("click",()=>changeCartQty(l.id,1));
      line.querySelector(".btn.ghost").addEventListener("click",()=>removeFromCart(l.id));
      list.appendChild(line);
    });
  }
  // Totals for Cart page
  calcTotals();
  const t = $("#cartTotals");
  t.innerHTML = `
    <div class="tot"><span>Subtotal ${state.totals.discount?`(−${money(state.totals.discount)} coupon)`:''}</span><b>${money(state.totals.subtotal - state.totals.discount)}</b></div>
    <div class="tot"><span class="muted">Shipping</span><span class="muted">${money(state.totals.shipping)}</span></div>
    <div class="tot"><span class="muted">COD Fee</span><span class="muted">${money(state.totals.cod)}</span></div>
    <div class="tot"><b>Total</b><b>${money(state.totals.grand)}</b></div>
  `;
}

/* ==========================
   CHECKOUT
========================== */
function renderCheckoutSummary(){
  // Protect route if empty
  if(getPath()==="/checkout" && !state.cart.length){
    $("#summaryList").innerHTML = `<div class="muted">Your cart is empty. <a href="#/products">Add products</a> to proceed.</div>`;
    $("#summaryTotals").innerHTML = "";
    return;
  }
  const list = $("#summaryList"); if(!list) return;
  list.innerHTML = "";
  state.cart.forEach(l=>{
    const p = PRODUCTS.find(x=>x.id===l.id);
    const row = document.createElement("div");
    row.className = "cart-line";
    row.innerHTML = `
      <div class="mini-img">${p.img}</div>
      <div>
        <div style="font-weight:700">${p.name}</div>
        <div class="muted">${p.id}</div>
      </div>
      <div><b>${l.qty} × ${money(l.price)}</b></div>`;
    list.appendChild(row);
  });
  calcTotals();
  $("#summaryTotals").innerHTML = `
    <div class="tot"><span>Subtotal ${state.totals.discount?`(−${money(state.totals.discount)} coupon)`:''}</span><b>${money(state.totals.subtotal - state.totals.discount)}</b></div>
    <div class="tot"><span class="muted">Shipping</span><span class="muted">${money(state.totals.shipping)}</span></div>
    <div class="tot"><span class="muted">COD Fee</span><span class="muted">${money(state.totals.cod)}</span></div>
    <div class="tot"><b>Total</b><b>${money(state.totals.grand)}</b></div>
  `;
}
function applyCoupon(){
  const code = ($("#checkoutForm [name=coupon]")?.value||"").trim().toUpperCase();
  const msg = $("#checkMsg");
  if(!code){ msg.className="msg err"; msg.textContent="Enter a code."; return; }
  if(!VALID_COUPONS[code]){ msg.className="msg err"; msg.textContent="Invalid code."; return; }
  state.coupon = code; renderCartPage(); renderCheckoutSummary(); msg.className="msg ok"; msg.textContent=`Applied ${code}.`;
}
function validPhone(s){ return /^[0-9]{10}$/.test((s||"").replace(/\D/g,"")) }
function validPin(s){ return /^[1-9][0-9]{5}$/.test((s||"").trim()) }
function placeOrder(e){
  e.preventDefault();
  const f = new FormData(e.target);
  const data = Object.fromEntries(f.entries());
  const msg = $("#checkMsg");

  if(!state.cart.length){ msg.className="msg err"; msg.textContent="Your cart is empty."; return false; }
  if(!validPhone(data.phone)){ msg.className="msg err"; msg.textContent="Enter a valid 10-digit phone."; return false; }
  if(!validPin(data.pincode)){ msg.className="msg err"; msg.textContent="Enter a valid 6-digit pincode."; return false; }
  if(!data.agree){ msg.className="msg err"; msg.textContent="Please agree to the terms."; return false; }

  // Compose order
  const orderId = "PE" + Date.now().toString().slice(-8);
  const items = state.cart.map(l=>{
    const p = PRODUCTS.find(x=>x.id===l.id);
    return { sku:l.id, name:p.name, qty:l.qty, price:l.price, line_total:l.qty*l.price };
  });
  const order = {
    order_id: orderId,
    created_at: new Date().toISOString(),
    payment: "COD",
    coupon: state.coupon,
    totals: state.totals,
    customer: {
      name: data.name, phone: data.phone, email: data.email||"",
      address: data.address, city: data.city, state: data.state, pincode: data.pincode,
      slot: data.slot
    },
    items
  };

  // Save locally
  const all = JSON.parse(localStorage.getItem("prepease_orders")||"[]");
  all.push(order);
  localStorage.setItem("prepease_orders", JSON.stringify(all));
  state.lastOrder = order;

  // Clear cart
  clearCart();
  $("#checkMsg").textContent = "";
  // Go to success page
  location.hash = "#/success";
  return false;
}

/* ==========================
   SUCCESS PAGE
========================== */
function composeOrderText(o){
  const items = o.items.map(i=>`${i.name} x ${i.qty} = ${i.line_total}`).join("%0A");
  return `New COD Order ${o.order_id}%0A%0A`+
         `Customer: ${o.customer.name}%0APhone: ${o.customer.phone}%0AEmail: ${o.customer.email||"-"}%0A`+
         `Address: ${o.customer.address}, ${o.customer.city} ${o.customer.pincode}, ${o.customer.state}%0A`+
         `Delivery: ${o.customer.slot}%0A%0A`+
         `Items:%0A${items}%0A%0A`+
         `Subtotal: ${o.totals.subtotal} - Discount: ${o.totals.discount}%0A`+
         `Shipping: ${o.totals.shipping} + COD: ${o.totals.cod}%0A`+
         `Total: ${o.totals.grand}%0A`;
}
function renderSuccessPage(){
  const o = state.lastOrder || (JSON.parse(localStorage.getItem("prepease_orders")||"[]").slice(-1)[0]);
  if(!o){ $("#successBox").innerHTML = `<div class="muted">No recent order.</div>`; return; }
  state.lastOrder = o;
  const box = $("#successBox");
  const lines = o.items.map(i=>`• ${i.name} × ${i.qty} = ${money(i.line_total)}`).join("<br>");
  box.innerHTML = `
    <b>Order ID:</b> ${o.order_id}<br>
    <b>Payment:</b> ${o.payment}<br>
    <b>Total:</b> ${money(o.totals.grand)}<br>
    <b>Customer:</b> ${o.customer.name}, ${o.customer.phone}<br>
    <b>Address:</b> ${o.customer.address}, ${o.customer.city} ${o.customer.pincode}, ${o.customer.state}<br>
    <b>Items:</b><br>${lines}
  `;
  const text = encodeURIComponent(composeOrderText(o));
  const wa = `https://wa.me/${STORE_WHATSAPP}?text=${text}`;
  const subj = encodeURIComponent(`New COD Order ${o.order_id} — ${o.customer.name}`);
  const mail = `mailto:${encodeURIComponent(STORE_EMAIL)}?subject=${subj}&body=${text}`;
  $("#waLink").href = wa;
  $("#mailLink").href = mail;
}
function downloadOrder(){
  const o = state.lastOrder; if(!o) return;
  const blob = new Blob([JSON.stringify(o,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${o.order_id}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ==========================
   CONTACT
========================== */
function handleContact(e){
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  $("#contactMsg").className="msg ok";
  $("#contactMsg").textContent = "Thanks! We'll get back to you.";
  e.target.reset();
  return false;
}

/* ==========================
   UTIL
========================== */
function viewLocalOrders(){
  const arr = JSON.parse(localStorage.getItem("prepease_orders")||"[]");
  if(!arr.length){ alert("No saved orders on this device yet."); return; }
  const text = arr.map(o=>`${o.order_id} — ${o.customer.name} — ${o.totals.grand}`).join("\n");
  alert("Saved Orders (this device):\n\n"+text+"\n\nOpen the Success page to export/WhatsApp/Email.");
}

/* ==========================
   INIT
========================== */
function init(){
  $("#year").textContent = new Date().getFullYear();
  updateCartCount();
  if(!location.hash) location.hash = "#/";
  navigate();
}
window.addEventListener("load", init);
</script>
</body>
</html>
